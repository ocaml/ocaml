
(**
   split_module_initialization decompose the toplevel expression generated by
   translmod into a list of expressions that correspond to the initialisation
   of globals.

   If a sequence does not contains initialisation of global fields, it
   is represented by the Effect constructor, meaning that the expression is
   used only for its side effects.

   If a sequence contains some initialisations (the Psetglobalfield primitive),
   then the transformed expression returns what was set into the field. Some
   expressions may set multiple fields. In that case the transformed expression
   returns a block with fields sorted following the index of the global field
   they correspond to.

   An example of an intricate cas assigning multiple field is:

   {[
     type t =
       | A of (int * int * int)
       | B of int * int

     let (A (a, _, b) | B (b, a)) = A (1, 2, 3)
   ]}

   The corresponding expression is

   (let (match/1012 = (makeblock 0 (makeblock 0 1 2 3)))
     (catch
      (switch* match/1012
        case tag 0:
         (let (match/1017 =a (field 0 match/1012))
           (exit 2 (field 0 match/1017) (field 2 match/1017)))
        case tag 1: (exit 2 (field 1 match/1012) (field 0 match/1012)))
     with (2 a/1005 b/1006)
      (seq (setfield_imm 0 (global Pattern!) a/1005)
        (setfield_imm 1 (global Pattern!) b/1006))))

   This expression is then turned into:

   (catch
     (let (match/1012 = (makeblock 0 (makeblock 0 1 2 3)))
       (catch
         (switch* match/1012
          case tag 0:
           (let (match/1017 =a (field 0 match/1012))
             (exit 2 (field 0 match/1017) (field 2 match/1017)))
          case tag 1:
           (exit 2 (field 1 match/1012) (field 0 match/1012)))
        with (2 a/1005 b/1006) (exit 3 a/1005 b/1006)))
    with (3 catch_init_0/1019 catch_init_1/1020)
     (makeblock 0 catch_init_0/1019 catch_init_1/1020))

*)


type initialisation =
  | Field_initialisations of int list
  | Effect

val split_module_initialization : Lambda.lambda -> (Lambda.lambda * initialisation) list
