type 'a r = {
  f000 : 'a; f001 : 'a; f002 : 'a; f003 : 'a; f004 : 'a; f005 : 'a; f006 : 'a;
  f007 : 'a; f008 : 'a; f009 : 'a; f010 : 'a; f011 : 'a; f012 : 'a; f013 : 'a;
  f014 : 'a; f015 : 'a; f016 : 'a; f017 : 'a; f018 : 'a; f019 : 'a; f020 : 'a;
  f021 : 'a; f022 : 'a; f023 : 'a; f024 : 'a; f025 : 'a; f026 : 'a; f027 : 'a;
  f028 : 'a; f029 : 'a; f030 : 'a; f031 : 'a; f032 : 'a; f033 : 'a; f034 : 'a;
  f035 : 'a; f036 : 'a; f037 : 'a; f038 : 'a; f039 : 'a; f040 : 'a; f041 : 'a;
  f042 : 'a; f043 : 'a; f044 : 'a; f045 : 'a; f046 : 'a; f047 : 'a; f048 : 'a;
  f049 : 'a; f050 : 'a; f051 : 'a; f052 : 'a; f053 : 'a; f054 : 'a; f055 : 'a;
  f056 : 'a; f057 : 'a; f058 : 'a; f059 : 'a; f060 : 'a; f061 : 'a; f062 : 'a;
  f063 : 'a; f064 : 'a; f065 : 'a; f066 : 'a; f067 : 'a; f068 : 'a; f069 : 'a;
  f070 : 'a; f071 : 'a; f072 : 'a; f073 : 'a; f074 : 'a; f075 : 'a; f076 : 'a;
  f077 : 'a; f078 : 'a; f079 : 'a; f080 : 'a; f081 : 'a; f082 : 'a; f083 : 'a;
  f084 : 'a; f085 : 'a; f086 : 'a; f087 : 'a; f088 : 'a; f089 : 'a; f090 : 'a;
  f091 : 'a; f092 : 'a; f093 : 'a; f094 : 'a; f095 : 'a; f096 : 'a; f097 : 'a;
  f098 : 'a; f099 : 'a; f100 : 'a; f101 : 'a; f102 : 'a; f103 : 'a; f104 : 'a;
  f105 : 'a; f106 : 'a; f107 : 'a; f108 : 'a; f109 : 'a; f110 : 'a; f111 : 'a;
  f112 : 'a; f113 : 'a; f114 : 'a; f115 : 'a; f116 : 'a; f117 : 'a; f118 : 'a;
  f119 : 'a; f120 : 'a; f121 : 'a; f122 : 'a; f123 : 'a; f124 : 'a; f125 : 'a;
  f126 : 'a; f127 : 'a; f128 : 'a; f129 : 'a; f130 : 'a; f131 : 'a; f132 : 'a;
  f133 : 'a; f134 : 'a; f135 : 'a; f136 : 'a; f137 : 'a; f138 : 'a; f139 : 'a;
  f140 : 'a; f141 : 'a; f142 : 'a; f143 : 'a; f144 : 'a; f145 : 'a; f146 : 'a;
  f147 : 'a; f148 : 'a; f149 : 'a; f150 : 'a; f151 : 'a; f152 : 'a; f153 : 'a;
  f154 : 'a; f155 : 'a; f156 : 'a; f157 : 'a; f158 : 'a; f159 : 'a; f160 : 'a;
  f161 : 'a; f162 : 'a; f163 : 'a; f164 : 'a; f165 : 'a; f166 : 'a; f167 : 'a;
  f168 : 'a; f169 : 'a; f170 : 'a; f171 : 'a; f172 : 'a; f173 : 'a; f174 : 'a;
  f175 : 'a; f176 : 'a; f177 : 'a; f178 : 'a; f179 : 'a; f180 : 'a; f181 : 'a;
  f182 : 'a; f183 : 'a; f184 : 'a; f185 : 'a; f186 : 'a; f187 : 'a; f188 : 'a;
  f189 : 'a; f190 : 'a; f191 : 'a; f192 : 'a; f193 : 'a; f194 : 'a; f195 : 'a;
  f196 : 'a; f197 : 'a; f198 : 'a; f199 : 'a; f200 : 'a; f201 : 'a; f202 : 'a;
  f203 : 'a; f204 : 'a; f205 : 'a; f206 : 'a; f207 : 'a; f208 : 'a; f209 : 'a;
  f210 : 'a; f211 : 'a; f212 : 'a; f213 : 'a; f214 : 'a; f215 : 'a; f216 : 'a;
  f217 : 'a; f218 : 'a; f219 : 'a; f220 : 'a; f221 : 'a; f222 : 'a; f223 : 'a;
  f224 : 'a; f225 : 'a; f226 : 'a; f227 : 'a; f228 : 'a; f229 : 'a; f230 : 'a;
  f231 : 'a; f232 : 'a; f233 : 'a; f234 : 'a; f235 : 'a; f236 : 'a; f237 : 'a;
  f238 : 'a; f239 : 'a; f240 : 'a; f241 : 'a; f242 : 'a; f243 : 'a; f244 : 'a;
  f245 : 'a; f246 : 'a; f247 : 'a; f248 : 'a; f249 : 'a; f250 : 'a; f251 : 'a;
  f252 : 'a; f253 : 'a; f254 : 'a; f255 : 'a; f256 : 'a; f257 : 'a; f258 : 'a;
  f259 : 'a; f260 : 'a; f261 : 'a; f262 : 'a; f263 : 'a; f264 : 'a; f265 : 'a;
  f266 : 'a; f267 : 'a; f268 : 'a; f269 : 'a; f270 : 'a; f271 : 'a; f272 : 'a;
  f273 : 'a; f274 : 'a; f275 : 'a; f276 : 'a; f277 : 'a; f278 : 'a; f279 : 'a;
  f280 : 'a; f281 : 'a; f282 : 'a; f283 : 'a; f284 : 'a; f285 : 'a; f286 : 'a;
  f287 : 'a; f288 : 'a; f289 : 'a; f290 : 'a; f291 : 'a; f292 : 'a; f293 : 'a;
  f294 : 'a; f295 : 'a; f296 : 'a; f297 : 'a; f298 : 'a; f299 : 'a; f300 : 'a;
}

let new_r x =
  {
    f000 = x; f001 = x; f002 = x; f003 = x; f004 = x; f005 = x; f006 = x;
    f007 = x; f008 = x; f009 = x; f010 = x; f011 = x; f012 = x; f013 = x;
    f014 = x; f015 = x; f016 = x; f017 = x; f018 = x; f019 = x; f020 = x;
    f021 = x; f022 = x; f023 = x; f024 = x; f025 = x; f026 = x; f027 = x;
    f028 = x; f029 = x; f030 = x; f031 = x; f032 = x; f033 = x; f034 = x;
    f035 = x; f036 = x; f037 = x; f038 = x; f039 = x; f040 = x; f041 = x;
    f042 = x; f043 = x; f044 = x; f045 = x; f046 = x; f047 = x; f048 = x;
    f049 = x; f050 = x; f051 = x; f052 = x; f053 = x; f054 = x; f055 = x;
    f056 = x; f057 = x; f058 = x; f059 = x; f060 = x; f061 = x; f062 = x;
    f063 = x; f064 = x; f065 = x; f066 = x; f067 = x; f068 = x; f069 = x;
    f070 = x; f071 = x; f072 = x; f073 = x; f074 = x; f075 = x; f076 = x;
    f077 = x; f078 = x; f079 = x; f080 = x; f081 = x; f082 = x; f083 = x;
    f084 = x; f085 = x; f086 = x; f087 = x; f088 = x; f089 = x; f090 = x;
    f091 = x; f092 = x; f093 = x; f094 = x; f095 = x; f096 = x; f097 = x;
    f098 = x; f099 = x; f100 = x; f101 = x; f102 = x; f103 = x; f104 = x;
    f105 = x; f106 = x; f107 = x; f108 = x; f109 = x; f110 = x; f111 = x;
    f112 = x; f113 = x; f114 = x; f115 = x; f116 = x; f117 = x; f118 = x;
    f119 = x; f120 = x; f121 = x; f122 = x; f123 = x; f124 = x; f125 = x;
    f126 = x; f127 = x; f128 = x; f129 = x; f130 = x; f131 = x; f132 = x;
    f133 = x; f134 = x; f135 = x; f136 = x; f137 = x; f138 = x; f139 = x;
    f140 = x; f141 = x; f142 = x; f143 = x; f144 = x; f145 = x; f146 = x;
    f147 = x; f148 = x; f149 = x; f150 = x; f151 = x; f152 = x; f153 = x;
    f154 = x; f155 = x; f156 = x; f157 = x; f158 = x; f159 = x; f160 = x;
    f161 = x; f162 = x; f163 = x; f164 = x; f165 = x; f166 = x; f167 = x;
    f168 = x; f169 = x; f170 = x; f171 = x; f172 = x; f173 = x; f174 = x;
    f175 = x; f176 = x; f177 = x; f178 = x; f179 = x; f180 = x; f181 = x;
    f182 = x; f183 = x; f184 = x; f185 = x; f186 = x; f187 = x; f188 = x;
    f189 = x; f190 = x; f191 = x; f192 = x; f193 = x; f194 = x; f195 = x;
    f196 = x; f197 = x; f198 = x; f199 = x; f200 = x; f201 = x; f202 = x;
    f203 = x; f204 = x; f205 = x; f206 = x; f207 = x; f208 = x; f209 = x;
    f210 = x; f211 = x; f212 = x; f213 = x; f214 = x; f215 = x; f216 = x;
    f217 = x; f218 = x; f219 = x; f220 = x; f221 = x; f222 = x; f223 = x;
    f224 = x; f225 = x; f226 = x; f227 = x; f228 = x; f229 = x; f230 = x;
    f231 = x; f232 = x; f233 = x; f234 = x; f235 = x; f236 = x; f237 = x;
    f238 = x; f239 = x; f240 = x; f241 = x; f242 = x; f243 = x; f244 = x;
    f245 = x; f246 = x; f247 = x; f248 = x; f249 = x; f250 = x; f251 = x;
    f252 = x; f253 = x; f254 = x; f255 = x; f256 = x; f257 = x; f258 = x;
    f259 = x; f260 = x; f261 = x; f262 = x; f263 = x; f264 = x; f265 = x;
    f266 = x; f267 = x; f268 = x; f269 = x; f270 = x; f271 = x; f272 = x;
    f273 = x; f274 = x; f275 = x; f276 = x; f277 = x; f278 = x; f279 = x;
    f280 = x; f281 = x; f282 = x; f283 = x; f284 = x; f285 = x; f286 = x;
    f287 = x; f288 = x; f289 = x; f290 = x; f291 = x; f292 = x; f293 = x;
    f294 = x; f295 = x; f296 = x; f297 = x; f298 = x; f299 = x; f300 = x;
  }

type 'a box = Box of 'a
type t = string ref box

let p s x =
  let ptr = Obj.(((magic (add_offset (repr x) Int32.one)) : int)) in
  Printf.printf "%s %x\n%!" s ptr


type phase =
| Starting
| DomainStarted
| MakingObject
| MadeObject
| GettingForeign
| GotForeign
| GcStart
| GcDone
| DerefForeign
| Finish1
| Finish2

let curr_phase = ref Starting
let transition a b =
  while not (Obj.(compare_and_swap_field (repr curr_phase) 0 (repr a) (repr b))) do () done

let go () =
  let r = ref None in
  ignore @@ Domain.spawn (fun () ->
    transition Starting DomainStarted;
    transition MadeObject GettingForeign;
    let foreign = match !r with Some {f000} -> f000 | None -> assert false in
    (*p "for" foreign;*)
    transition GettingForeign GotForeign;
    transition GcDone DerefForeign;
    Printf.printf "message: %s\n" (let Box r = foreign in !r);
    transition DerefForeign Finish1);
  transition DomainStarted MakingObject;
  let g = new_r (Box (ref "hello")) in
  (*p "g" g;
  p "f0" g.f000;*)
  r := Some g;
  transition MakingObject MadeObject;
  transition GotForeign GcStart;
  Gc.full_major ();
  let rec minor_junk a = function 0 -> [] | n -> minor_junk (Some n) (n-1) in
  let _ = Obj.(is_block (repr (minor_junk None 10000))) in
  transition GcStart GcDone;
  transition Finish1 Finish2

let () = go ()
