(* This test asserts that when the match in [f] below is optimized away; the result isn't
   incorrectly marked as a non-pointer *)

type t =
  | T_0 | T_1 | T_2 | T_3 | T_4 | T_5 | T_6 | T_7 | T_8 | T_9 | T_10 | T_11 | T_12 | T_13
  | T_14 | T_15 | T_16 | T_17 | T_18 | T_19 | T_20 | T_21 | T_22 | T_23 | T_24 | T_25 | T_26
  | T_27 | T_28 | T_29 | T_30 | T_31 | T_32 | T_33 | T_34 | T_35 | T_36 | T_37 | T_38 | T_39
  | T_40 | T_41 | T_42 | T_43 | T_44 | T_45 | T_46 | T_47 | T_48 | T_49 | T_50 | T_51 | T_52
  | T_53 | T_54 | T_55 | T_56 | T_57 | T_58 | T_59 | T_60 | T_61 | T_62 | T_63 | T_64 | T_65
  | T_66 | T_67 | T_68 | T_69 | T_70 | T_71 | T_72 | T_73 | T_74 | T_75 | T_76 | T_77 | T_78
  | T_79 | T_80 | T_81 | T_82 | T_83 | T_84 | T_85 | T_86 | T_87 | T_88 | T_89 | T_90 | T_91
  | T_92 | T_93 | T_94 | T_95 | T_96 | T_97 | T_98 | T_99 | T_100 | T_101 | T_102 | T_103
  | T_104 | T_105 | T_106 | T_107 | T_108 | T_109 | T_110 | T_111 | T_112 | T_113 | T_114
  | T_115 | T_116 | T_117 | T_118 | T_119 | T_120 | T_121 | T_122 | T_123 | T_124 | T_125
  | T_126 | T_127 | T_128 | T_129 | T_130 | T_131 | T_132 | T_133 | T_134 | T_135 | T_136
  | T_137 | T_138 | T_139 | T_140 | T_141 | T_142 | T_143 | T_144 | T_145 | T_146 | T_147
  | T_148 | T_149 | T_150 | T_151 | T_152 | T_153 | T_154 | T_155 | T_156 | T_157 | T_158
  | T_159 | T_160 | T_161 | T_162 | T_163 | T_164 | T_165 | T_166 | T_167 | T_168 | T_169
  | T_170 | T_171 | T_172 | T_173 | T_174 | T_175 | T_176 | T_177 | T_178 | T_179 | T_180
  | T_181 | T_182 | T_183 | T_184 | T_185 | T_186 | T_187 | T_188 | T_189 | T_190 | T_191
  | T_192 | T_193 | T_194 | T_195 | T_196 | T_197 | T_198 | T_199 | T_200 | T_201 | T_202
  | T_203 | T_204 | T_205 | T_206 | T_207 | T_208 | T_209 | T_210 | T_211 | T_212 | T_213
  | T_214 | T_215 | T_216 | T_217 | T_218 | T_219 | T_220 | T_221 | T_222 | T_223 | T_224
  | T_225 | T_226 | T_227 | T_228 | T_229 | T_230 | T_231 | T_232 | T_233 | T_234 | T_235
  | T_236 | T_237 | T_238 | T_239 | T_240 | T_241 | T_242 | T_243 | T_244 | T_245 | T_246
  | T_247 | T_248 | T_249 | T_250 | T_251 | T_252 | T_253 | T_254 | T_255
  | Bloc of int

let f = function
| '\000' -> T_0
| '\001' -> T_1
| '\002' -> T_2
| '\003' -> T_3
| '\004' -> T_4
| '\005' -> T_5
| '\006' -> T_6
| '\007' -> T_7
| '\008' -> T_8
| '\009' -> T_9
| '\010' -> T_10
| '\011' -> T_11
| '\012' -> T_12
| '\013' -> T_13
| '\014' -> T_14
| '\015' -> T_15
| '\016' -> T_16
| '\017' -> T_17
| '\018' -> T_18
| '\019' -> T_19
| '\020' -> T_20
| '\021' -> T_21
| '\022' -> T_22
| '\023' -> T_23
| '\024' -> T_24
| '\025' -> T_25
| '\026' -> T_26
| '\027' -> T_27
| '\028' -> T_28
| '\029' -> T_29
| '\030' -> T_30
| '\031' -> T_31
| '\032' -> T_32
| '\033' -> T_33
| '\034' -> T_34
| '\035' -> T_35
| '\036' -> T_36
| '\037' -> T_37
| '\038' -> T_38
| '\039' -> T_39
| '\040' -> T_40
| '\041' -> T_41
| '\042' -> T_42
| '\043' -> T_43
| '\044' -> T_44
| '\045' -> T_45
| '\046' -> T_46
| '\047' -> T_47
| '\048' -> T_48
| '\049' -> T_49
| '\050' -> T_50
| '\051' -> T_51
| '\052' -> T_52
| '\053' -> T_53
| '\054' -> T_54
| '\055' -> T_55
| '\056' -> T_56
| '\057' -> T_57
| '\058' -> T_58
| '\059' -> T_59
| '\060' -> T_60
| '\061' -> T_61
| '\062' -> T_62
| '\063' -> T_63
| '\064' -> T_64
| '\065' -> T_65
| '\066' -> T_66
| '\067' -> T_67
| '\068' -> T_68
| '\069' -> T_69
| '\070' -> T_70
| '\071' -> T_71
| '\072' -> T_72
| '\073' -> T_73
| '\074' -> T_74
| '\075' -> T_75
| '\076' -> T_76
| '\077' -> T_77
| '\078' -> T_78
| '\079' -> T_79
| '\080' -> T_80
| '\081' -> T_81
| '\082' -> T_82
| '\083' -> T_83
| '\084' -> T_84
| '\085' -> T_85
| '\086' -> T_86
| '\087' -> T_87
| '\088' -> T_88
| '\089' -> T_89
| '\090' -> T_90
| '\091' -> T_91
| '\092' -> T_92
| '\093' -> T_93
| '\094' -> T_94
| '\095' -> T_95
| '\096' -> T_96
| '\097' -> T_97
| '\098' -> T_98
| '\099' -> T_99
| '\100' -> T_100
| '\101' -> T_101
| '\102' -> T_102
| '\103' -> T_103
| '\104' -> T_104
| '\105' -> T_105
| '\106' -> T_106
| '\107' -> T_107
| '\108' -> T_108
| '\109' -> T_109
| '\110' -> T_110
| '\111' -> T_111
| '\112' -> T_112
| '\113' -> T_113
| '\114' -> T_114
| '\115' -> T_115
| '\116' -> T_116
| '\117' -> T_117
| '\118' -> T_118
| '\119' -> T_119
| '\120' -> T_120
| '\121' -> T_121
| '\122' -> T_122
| '\123' -> T_123
| '\124' -> T_124
| '\125' -> T_125
| '\126' -> T_126
| '\127' -> T_127
| '\128' -> T_128
| '\129' -> T_129
| '\130' -> T_130
| '\131' -> T_131
| '\132' -> T_132
| '\133' -> T_133
| '\134' -> T_134
| '\135' -> T_135
| '\136' -> T_136
| '\137' -> T_137
| '\138' -> T_138
| '\139' -> T_139
| '\140' -> T_140
| '\141' -> T_141
| '\142' -> T_142
| '\143' -> T_143
| '\144' -> T_144
| '\145' -> T_145
| '\146' -> T_146
| '\147' -> T_147
| '\148' -> T_148
| '\149' -> T_149
| '\150' -> T_150
| '\151' -> T_151
| '\152' -> T_152
| '\153' -> T_153
| '\154' -> T_154
| '\155' -> T_155
| '\156' -> T_156
| '\157' -> T_157
| '\158' -> T_158
| '\159' -> T_159
| '\160' -> T_160
| '\161' -> T_161
| '\162' -> T_162
| '\163' -> T_163
| '\164' -> T_164
| '\165' -> T_165
| '\166' -> T_166
| '\167' -> T_167
| '\168' -> T_168
| '\169' -> T_169
| '\170' -> T_170
| '\171' -> T_171
| '\172' -> T_172
| '\173' -> T_173
| '\174' -> T_174
| '\175' -> T_175
| '\176' -> T_176
| '\177' -> T_177
| '\178' -> T_178
| '\179' -> T_179
| '\180' -> T_180
| '\181' -> T_181
| '\182' -> T_182
| '\183' -> T_183
| '\184' -> T_184
| '\185' -> T_185
| '\186' -> T_186
| '\187' -> T_187
| '\188' -> T_188
| '\189' -> T_189
| '\190' -> T_190
| '\191' -> T_191
| '\192' -> T_192
| '\193' -> T_193
| '\194' -> T_194
| '\195' -> T_195
| '\196' -> T_196
| '\197' -> T_197
| '\198' -> T_198
| '\199' -> T_199
| '\200' -> T_200
| '\201' -> T_201
| '\202' -> T_202
| '\203' -> T_203
| '\204' -> T_204
| '\205' -> T_205
| '\206' -> T_206
| '\207' -> T_207
| '\208' -> T_208
| '\209' -> T_209
| '\210' -> T_210
| '\211' -> T_211
| '\212' -> T_212
| '\213' -> T_213
| '\214' -> T_214
| '\215' -> T_215
| '\216' -> T_216
| '\217' -> T_217
| '\218' -> T_218
| '\219' -> T_219
| '\220' -> T_220
| '\221' -> T_221
| '\222' -> T_222
| '\223' -> T_223
| '\224' -> T_224
| '\225' -> T_225
| '\226' -> T_226
| '\227' -> T_227
| '\228' -> T_228
| '\229' -> T_229
| '\230' -> T_230
| '\231' -> T_231
| '\232' -> T_232
| '\233' -> T_233
| '\234' -> T_234
| '\235' -> T_235
| '\236' -> T_236
| '\237' -> T_237
| '\238' -> T_238
| '\239' -> T_239
| '\240' -> T_240
| '\241' -> T_241
| '\242' -> T_242
| '\243' -> T_243
| '\244' -> T_244
| '\245' -> T_245
| '\246' -> T_246
| '\247' -> T_247
| '\248' -> T_248
| '\249' -> T_249
| '\250' -> T_250
| '\251' -> T_251
| '\252' -> T_252
| '\253' -> T_253
| '\254' -> T_254
| '\255' -> T_255
  [@@inline]

external p : t -> int = "%int_as_pointer" (* used to compare pointers.
                                             Please do not use for anything else ! *)

let ref_juggle n =
  let r = ref (f 'a') in (* The inliner will get rid of f, replacing the expression
                            by the integer '97'.
                            This reference being used with the right pattern will be
                            converted to a mutable variable *)
  let r' = ref (f 'a') in
  for i = 0 to 1 do      (* This is a trick to circumvent a bugfix from 4.03 *)
    r' := !r;            (* Move the content of mutable variable r to r'.
                            Since r was not assigned to Bloc yet, it was not
                            converted to a register potentially containing a
                            pointer. So it will not turn r' into that kind of
                            register.
                            On the second round of the loop, this will contain
                            (Bloc n) *)
    r := Bloc n;
  done;
  let old_address = p !r in (* Read the address of (Bloc n) before the collection *)
  (* r' is spilled to the stack *)
  Gc.minor ();           (* (Bloc n) is fresh, hence allocated on the minor heap: this
                            moves it to the major heap *)
  (* r' is recovered from the stack *)
  let new_address = p !r in
  (match old_address = new_address with
  | true -> print_string "same"
  | false -> print_string "not same"
  );
  print_newline ();
  for i = 0 to 10000 do
    ignore (Sys.opaque_identity (i, i));
                         (* Fill the minor heap to overwrite the content pointed by 'r *)
  done;
  (match !r' with
   | Bloc n ->
     print_int n;
     print_newline ()
   | _ -> ());
  [@@inline never]       (* Ensure that f is not inlined to avoid propagating the
                            constant n. Otherwise (Bloc n) would have been statically
                            allocated hence, couldn't move during a collection *)

let () =
  List.iter
    ref_juggle
    [1; 42; 100]
